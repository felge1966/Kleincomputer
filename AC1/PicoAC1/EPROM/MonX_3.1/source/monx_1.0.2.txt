 AC1 U880 Assembler - Source Listing               0010 ; Sprungvetteiler Ur-AC1A433 07EB     0020 MS30   EQU  07EBHA433 07EE     0030 OUTHEX EQU  07EEHA433 07F1     0040 OUTHL  EQU  07F1HA433 07F4     0050 INLINE EQU  07F4HA433 07F7     0060 INHEX  EQU  07F7HA433 07FA     0070 TASTTE EQU  07FAHA433 07FD     0080 GETCO1 EQU  07FDH              0090 ;              0100 ; Systemzellen Ur-AC1A433 181A     0110 SOIL   EQU  181AHA433 185B     0120 ARG1   EQU  185BHA433 185D     0130 ARG2   EQU  185DHA433 185F     0140 ARG3   EQU  185FH              0150 ;1880          0160        ORG  1880H              0170 ; Systemzellen der pico-Erw.              0180 ; nicht direkt zugreifen ! --> FGETSY1880 0002     0190 FRESCO DEFS 2     ;Fehlercode ext. Save/Load1882 0002     0200 FLEN   DEFS 2     ;Laenge des Speicherblocks1884 0002     0210 FPOS   DEFS 2     ;Position des akt Zeichens1886 0002     0220 FRESV  DEFS 2     ;Reserve fuer Erweiterung1888 0001     0230 FTYPE  DEFS 1     ;Filetyp1889 0010     0240 BUFLEN EQU  16    ;max Textpuffer1889 0010     0250 TXTBUF DEFS BUFLEN ;Textpuffer (Name)1899 0002     0260 FCSUM  DEFS 2     ;Zwischenerg.CSum              0270 ;              0280 ;189B 0004     0290 PIODA  EQU  4189B 0005     0300 PIODB  EQU  5189B 0006     0310 PIOCA  EQU  6189B 0007     0320 PIOCB  EQU  7              0330 ;189B 0005     0340 CLK    EQU  5     ;Taktletung PIOB-Bit --> P189B 0004     0350 DATA   EQU  4     ;bidrektional Daten-Ltg              0360 ;              0370 ;      Kennbuchstaben Monitorerweiterung189B 0073     0380 KSAVE  EQU  "s189B 006C     0390 KLOAD  EQU  "l189B 0074     0400 KTIME  EQU  "t189B 0064     0410 KDIR   EQU  "d189B 006D     0420 KMDIR  EQU  "m189B 0063     0430 KCOLOR EQU  "c189B 0048     0440 KHELP  EQU  "H189B 0068     0450 KHELPX EQU  "h189B 0070     0460 KPRNTX EQU  "p189B 00F7     0470 KFOPNW EQU  "w+80H189B 00F2     0480 KFOPNR EQU  "r+80H189B 00EB     0490 KEXCMD EQU  "k+80H              0500 ;189B 0055     0510 CSYNC  EQU  55H         ;ZCOM Synczeichen              0520 ; -----------------------------------------              0530 ;0800          0540        ORG  0800H              0550 ;              0560 ; Ausgabe Versionsstring f.Ueberschrift0800 DF       0570 VERSTR RST  18H0801 53442031 0580        DEFM "SD 1.0.2"     2E302E320809 AA       0590        DEFB "*+80H080A C9       0600        RET              0610 ;0810          0620        ORG  0810H              0630 ;              0640 ; Sprungverteiler Monitorerweiterung -------0810 C34308   0650        JP   CLRBUF ;Namebuffer loeschen0813 C35508   0660        JP   FGETSY ;Re:Zeiger auf SysRAM0816 C36208   0670        JP   GETTXT ;EingabeTxt ab SOIL v.BWS0819 C36608   0680        JP   GETTX0 ;EingabeTxt ab HL vom BWS081C C3400B   0690        JP   PRNTXA ;A -> Druckdatei081F C39C08   0700        JP   CRC16  ;CRC-Summe Speicherbereic0822 C34E0B   0710        JP   FOPENW ;ext. Datei open write0825 C3A90B   0720        JP   FCHRW  ;Byte in ext.Datei schr.0828 C3EF0B   0730        JP   FBLKW  ;Speicheblock in ext.schr082B C3FF0B   0740        JP   FOPENR ;ext.Datei open read082E C3B00C   0750        JP   FCHRR  ;Byte aus ext.Datei lesen0831 C3EA0C   0760        JP   FBLKR  ;Speicherblock lesen0834 C35C08   0770        JP   FGETRE ;ResCode FileOP Z/0000=Ok0837 C30008   0780        JP   VERSTR ;Ausgabe Versionsstr.              0790 ;              0800 ;083A 20       0810        DEFB 20H         ;DummyString083B 2A20     0820 DEFSTR DEFM "* "083D 7069636F 0830 AC1ID  DEFM "picoac"    ;6Z f. Dateiheader     6163              0840 ; ------------------------------------------              0850 ;      System-Text-Puffer loeschen (Spaces)0843 F5       0860 CLRBUF PUSH AF0844 C5       0870        PUSH BC0845 D5       0880        PUSH DE0846 0610     0890        LD   B,BUFLEN0848 3E20     0900        LD   A,20H084A 118918   0910        LD   DE,TXTBUF084D 12       0920 CLRBU1 LD   (DE),A084E 13       0930        INC  DE084F 10FC     0940        DJNZ CLRBU10851 D1       0950        POP  DE0852 C1       0960        POP  BC0853 F1       0970        POP  AF0854 C9       0980        RET              0990 ;              1000 ; Zeiger auf SystemRAM der Pico-Erw.              1010 ; In: HL - Offset zur ersten Zelle              1020 ; Out HL - Adresse der Systemzelle0855 D5       1030 FGETSY PUSH DE0856 118018   1040        LD   DE,FRESCO0859 19       1050        ADD  HL,DE085A D1       1060        POP  DE085B C9       1070        RET              1080 ;              1090 ; Ergenis der letzten FileOP              1100 ; HL=0000h / Z-Flag ==> Ok085C 2A8018   1110 FGETRE LD   HL,(FRESCO)085F 7D       1120        LD   A,L0860 B4       1130        OR   H0861 C9       1140        RET              1150 ;              1160 ;              1170 ; Text aus Bildzeile in Systempuffer kopiere              1180 ; In: HL=1.Bildposition oder (SOIL)              1190 ; Out: StrLen --> HL              1200 ;              1210 ;      Suche hinter Kennbuchstaben0862 2A1A18   1220 GETTXT LD   HL,(SOIL)0865 2B       1230        DEC  HL              1240 ;      Suche ab HL - revese0866 F5       1250 GETTX0 PUSH AF0867 D5       1260        PUSH DE0868 C5       1270        PUSH BC0869 CD4308   1280        CALL CLRBUF              1290 ;              1300 ;      Doppelp. auf 1.Position ueberspringen086C 7E       1310        LD   A,(HL)086D FE3A     1320        CP   ":086F 2001     1330        JR   NZ,GETTX20871 2B       1340        DEC  HL              1350 ;      max. 10 Leerz. vor Text0872 060A     1360 GETTX2 LD   B,100874 7E       1370 GETTX3 LD   A,(HL)0875 FE20     1380        CP   20H0877 C28208   1390        JP   NZ,GETTX4087A 2B       1400        DEC  HL087B 10F7     1410        DJNZ GETTX3087D 210000   1420        LD   HL,00880 1816     1430        JR   GETTXX      ;kein Text gefunden              1440 ;              1450 ; String bis zum naechsten Leez. kopieren0882 118918   1460 GETTX4 LD   DE,TXTBUF0885 0610     1470        LD   B,BUFLEN0887 7E       1480 GETTX5 LD   A,(HL)0888 FE20     1490        CP   20H         ;StringEnde?088A 2805     1500        JR   Z,GETTX6088C 12       1510        LD   (DE),A088D 2B       1520        DEC  HL088E 13       1530        INC  DE088F 10F6     1540        DJNZ GETTX50891 EB       1550 GETTX6 EX   DE,HL0892 118918   1560        LD   DE,TXTBUF0895 A7       1570        AND  A0896 ED52     1580        SBC  HL,DE       ;StrLen -> HL0898 C1       1590 GETTXX POP  BC0899 D1       1600        POP  DE089A F1       1610        POP  AF089B C9       1620        RET              1630 ; ------------------------------------------              1640 ;      CRC16-CITT              1650 ;      Poly: 1021h / Seed: FFFFh              1660 ;      Input              1670 ;        IX: Data-Adress              1680 ;        DE: Data-Length              1690 ;      Output: HL              1700 ;      Modified: IX,DE,BC,AF,HL              1710 ;089C 21FFFF   1720 CRC16  LD   HL,0FFFFH089F 0E08     1730        LD   C,808A1 7C       1740 CRC16A LD   A,H08A2 DDAE00   1750        XOR  (IX+0)08A5 67       1760        LD   H,A08A6 DD23     1770        INC  IX08A8 41       1780        LD   B,C08A9 29       1790 CRC16B ADD  HL,HL08AA 3008     1800        JR   NC,CRC16C08AC 7C       1810        LD   A,H08AD EE10     1820        XOR  10H08AF 67       1830        LD   H,A08B0 7D       1840        LD   A,L08B1 EE21     1850        XOR  21H08B3 6F       1860        LD   L,A08B4 10F3     1870 CRC16C DJNZ CRC16B08B6 1B       1880        DEC  DE08B7 7A       1890        LD   A,D08B8 B3       1900        OR   E08B9 20E6     1910        JR   NZ,CRC16A08BB C9       1920        RET              1930 ;              1940 ;              1950 ;              1960 ;      Initialisierung ZCOM              1970 ;      PIO Schreibrichtung08BC F5       1980 PICOMW PUSH AF08BD 3ECF     1990        LD   A,0CFH      ;PIO Mode 308BF D307     2000        OUT  (PIOCB),A08C1 3E8F     2010        LD   A,08FH      ;10001111 Bitrichtun08C3 D307     2020        OUT  (PIOCB),A08C5 AF       2030        XOR  A08C6 D305     2040        OUT  (PIODB),A   ;Data & CLk -> 008C8 3E14     2050        LD   A,20        ;Low verlaengern08CA 3D       2060 PICOM1 DEC  A08CB 20FD     2070        JR   NZ,PICOM1              2080 ;      Masterkennung08CD 3EC3     2090        LD   A,0C3H08CF CDE308   2100        CALL WRBYTE08D2 3E25     2110        LD   A,25H08D4 CDE308   2120        CALL WRBYTE08D7 3EA7     2130        LD   A,0A7H08D9 CDE308   2140        CALL WRBYTE08DC 3E56     2150        LD   A,56H08DE CDE308   2160        CALL WRBYTE08E1 F1       2170        POP  AF08E2 C9       2180        RET              2190 ;      ---------------              2200 ;              2210 ;      Zeichen in A augeben08E3 C5       2220 WRBYTE PUSH BC08E4 F5       2230        PUSH AF08E5 0608     2240        LD   B,8          ;Bitzaehler08E7 4F       2250        LD   C,A08E8 DB05     2260        IN   A,(PIODB)08EA CBAF     2270        RES  CLK,A         ;Anfangzust. CLK08EC D305     2280        OUT  (PIODB),A              2290 ;08EE DB05     2300 WRBY1  IN   A,(PIODB)08F0 E6CF     2310        AND  0CFH        ;CLK & Daten !08F2 CB40     2320        BIT  0,B08F4 2002     2330        JR   NZ,WRBY208F6 CBEF     2340        SET  CLK,A08F8 CB29     2350 WRBY2  SRA  C           ;Datenbit -> Cy08FA 3002     2360        JR   NC,WRBY308FC CBE7     2370        SET  DATA,A08FE D305     2380 WRBY3  OUT  (PIODB),A0900 10EC     2390        DJNZ WRBY10902 F1       2400        POP  AF0903 C1       2410        POP  BC0904 C9       2420        RET              2430 ;      ----------------              2440 ;              2450 ;      PIO in Leserichtung umschalten              2460 ;      auf Synchronbyte "55H" warten0905 C5       2470 RDSYNC PUSH BC              2480 ;      PUSH DE0906 E5       2490        PUSH HL0907 3ECF     2500        LD   A,0CFH      ;PIO Mode 30909 D307     2510        OUT  (PIOCB),A090B 3E9F     2520        LD   A,9FH      ;1001 1111 Richtung090D D307     2530        OUT  (PIOCB),A090F 21B80B   2540        LD   HL,3000     ;max x Flanken              2550 ;      LD   DE,1        ;dec HL0912 0E00     2560        LD   C,00914 DB05     2570 RDSY1  IN   A,(PIODB)0916 EE20     2580        XOR  20H          ;CLK toggeln0918 D305     2590        OUT  (PIODB),A091A CB39     2600        SRL  C091C CB67     2610        BIT  DATA,A091E 2802     2620        JR   Z,RDSY30920 CBF9     2630        SET  7,C0922 79       2640 RDSY3  LD   A,C0923 FE55     2650        CP   CSYNC0925 2813     2660        JR   Z,RDSY4              2670 ;      Takvezoegerung0927 AF       2680        XOR  A           ;Cy = 00928 3D       2690 RDSY5  DEC  A           ;Cy unveraendert0929 20FD     2700        JR   NZ,RDSY5              2710 ;      SBC  HL,DE       ;HL - 1092B 2B       2720        DEC  HL092C 7D       2730        LD   A,L092D B4       2740        OR   H           ; HL = 0 ??092E 20E4     2750        JR   NZ,RDSY10930 DF       2760        RST  18H0931 54494D45 2770        DEFM "TIMEOU"     4F550937 D4       2780        DEFB "T+80H0938 3EFF     2790        LD   A,0FFH      ;A: FFH = Fehler093A E1       2800 RDSY4  POP  HL              2810 ;      POP  DE093B C1       2820        POP  BC093C C9       2830        RET  ;A: CSYN = Ok              2840 ;      ----------------              2850 ;              2860 ;      Zeichen vom Pico lesen              2870 ;      Ergebnis in A              2880 ;      Datenbit 0 steht bereits an093D C5       2890 RDBYTE PUSH BC093E 0608     2900        LD   B,8         ;Bitzaehler0940 0E00     2910        LD   C,0         ;Ergebnis0942 DB05     2920 RDBY1  IN   A,(PIODB)0944 EE20     2930        XOR  20H          ;CLK toggeln0946 D305     2940        OUT  (PIODB),A0948 CB39     2950        SRL  C094A CB67     2960        BIT  DATA,A094C 2802     2970        JR   Z,RDBY2094E CBF9     2980        SET  7,C0950 10F0     2990 RDBY2  DJNZ RDBY10952 79       3000        LD   A,C0953 C1       3010        POP  BC0954 C9       3020        RET              3030 ;      --------------              3040 ;              3050 ;      Datei-Header an Pico senden              3060 ;      A => Dateityp - "P|D|B|F|E"              3070 ;      ARG1-3 in Systemzellen0955 F5       3080 WRHDR  PUSH AF0956 215B18   3090        LD   HL,ARG10959 0606     3100        LD   B,6         ;6 Bytes095B 0E00     3110        LD   C,0         ;Pruefsumme095D 7E       3120 WRHDR0 LD   A,(HL)095E CDE308   3130        CALL WRBYTE0961 81       3140        ADD  A,C0962 4F       3150        LD   C,A0963 23       3160        INC  HL0964 10F7     3170        DJNZ WRHDR0              3180 ;0966 0606     3190        LD   B,6         ;Kennung 6 Zeichen0968 213D08   3200        LD   HL,AC1ID096B 7E       3210 WRHDR7 LD   A,(HL)096C CDE308   3220        CALL WRBYTE096F 23       3230        INC  HL0970 81       3240        ADD  A,C0971 4F       3250        LD   C,A0972 10F7     3260        DJNZ WRHDR7              3270 ;0974 F1       3280        POP  AF          ;Dateityp0975 CDE308   3290        CALL WRBYTE0978 81       3300        ADD  A,C0979 4F       3310        LD   C,A              3320 ;097A 0603     3330        LD   B,3          ;3x Magic Bytes097C 3ED3     3340 WRHDR8 LD   A,0D3H097E CDE308   3350        CALL WRBYTE0981 81       3360        ADD  A,C0982 4F       3370        LD   C,A0983 10F7     3380        DJNZ WRHDR80985 1807     3390        JR   WRHDR5              3400 ;              3410 ;      Einsprung "nur Zeichenkette senden"0987 0E00     3420 WRHDRX LD   C,00989 ED5B1A18 3430        LD   DE,(SOIL)098D 1B       3440        DEC  DE098E 060A     3450 WRHDR5 LD   B,10        ;max 10 Leerz. vor S0990 1A       3460 WRHDR1 LD   A,(DE)0991 FE3A     3470        CP   ":          ;Doppelpunkt uebesp.0993 2804     3480        JR   Z,WRHDR60995 FE20     3490        CP   20H         ;Beginn String suche0997 2006     3500        JR   NZ,WRHDR20999 1B       3510 WRHDR6 DEC  DE099A 10F4     3520        DJNZ WRHDR1099C 113B08   3530        LD   DE,DEFSTR   ;Default-String099F 0621     3540 WRHDR2 LD   B,33        ;16Z Name'/'16Z Info09A1 1A       3550 WRHDR4 LD   A,(DE)09A2 1B       3560        DEC  DE09A3 FE20     3570        CP   20H         ;Ende String suchen09A5 2807     3580        JR   Z,WRHDR309A7 CDE308   3590        CALL WRBYTE09AA 81       3600        ADD  A,C09AB 4F       3610        LD   C,A09AC 10F3     3620        DJNZ WRHDR409AE AF       3630 WRHDR3 XOR  A           ;Schlusskennung09AF CDE308   3640        CALL WRBYTE09B2 79       3650        LD   A,C         ;Pruefsumme Header09B3 CDE308   3660        CALL WRBYTE09B6 C9       3670        RET              3680 ;      ---------------              3690 ;      Fehlermeldung + Abbruch09B7 F5       3700 ECSUM  PUSH AF09B8 DF       3710        RST  18H09B9 4353554D 3720        DEFM "CSUM ERRO"     20455252     4F09C2 D2       3730        DEFB "R+80H09C3 F1       3740        POP  AF09C4 C9       3750        RET              3760 ;      ----------------              3770 ;              3780 ;      Hex-Ausgbe ARG1-309C5 E5       3790 PRARGS PUSH HL09C6 DF       3800        RST  18H09C7 2041     3810        DEFM " A"09C9 3A80     3820        DEFB ": +80H09CB 2A5B18   3830        LD   HL,(ARG1)09CE CDF107   3840        CALL OUTHL09D1 DF       3850        RST  18H09D2 2045     3860        DEFM " E"09D4 3A80     3870        DEFB ": +80H09D6 2A5D18   3880        LD   HL,(ARG2)09D9 CDF107   3890        CALL OUTHL09DC DF       3900        RST  18H09DD 2053     3910        DEFM " S"09DF 3A80     3920        DEFB ": +80H09E1 2A5F18   3930        LD   HL,(ARG3)09E4 CDF107   3940        CALL OUTHL09E7 E1       3950        POP  HL09E8 C9       3960        RET              3970 ;              3980 ;      ***************************              3990 ;      Datenfile an Pico senden09E9 0009730D 4000        DEFB 0,9,KSAVE,0DH  ;Kennbuchstabe              4010 ;09ED 2A5B18   4020        LD   HL,(ARG1)   ;Ende > Anfang ?09F0 ED4B5D18 4030        LD   BC,(ARG2)09F4 A7       4040        AND  A           ;Cy = 009F5 ED42     4050        SBC  HL,BC09F7 D0       4060        RET  NC              4070 ;09F8 CDBC08   4080        CALL PICOMW      ;PIO Schreibrichtung09FB 3E73     4090        LD   A,KSAVE     ;Kommando -> Pico09FD CDE308   4100        CALL WRBYTE              4110 ;0A00 3E44     4120        LD   A,"D        ;Kennung0A02 CD5509   4130        CALL WRHDR       ;Datei-Header senden              4140 ;              4150 ;      Daten sichen0A05 ED5B5B18 4160 SVDATA LD   DE,(ARG1)   ;Anfang0A09 2A5D18   4170        LD   HL,(ARG2)   ;Ende0A0C A7       4180        AND  A           ;Cy=00A0D ED52     4190        SBC  HL,DE0A0F 23       4200        INC  HL          ;Laenge              4210 ;      Blockanfang0A10 010000   4220 SDWR10 LD   BC,0        ;Block=256By/CSum=00A13 7C       4230        LD   A,H0A14 A7       4240        AND  A           ;H=0? ==> <256 Bytes0A15 2005     4250        JR   NZ,SDWR120A17 7D       4260        LD   A,L         ;HL=0?0A18 A7       4270        AND  A0A19 2811     4280        JR   Z,SDWRE2    ;Ende0A1B 45       4290        LD   B,L         ;Restblock0A1C 1A       4300 SDWR12 LD   A,(DE)0A1D CDE308   4310        CALL WRBYTE0A20 81       4320        ADD  A,C0A21 4F       4330        LD   C,A0A22 13       4340        INC  DE          ;naechste Adr0A23 2B       4350        DEC  HL          ;Restlaenge -10A24 10F6     4360        DJNZ SDWR12              4370 ;      Ausgabe Pruefsumme0A26 79       4380        LD   A,C0A27 CDE308   4390        CALL WRBYTE0A2A 18E4     4400        JR   SDWR10              4410 ;              4420 ;      warten auf Meldung vom Pico0A2C CD0509   4430 SDWRE2 CALL RDSYNC0A2F FE55     4440        CP   55H         ;Syncbyte korrekt?0A31 C0       4450        RET  NZ              4460 ;0A32 CD3D09   4470        CALL RDBYTE      ;Responsetyp 01              4480 ;0A35 CD3D09   4490 SDWRE3 CALL RDBYTE0A38 A7       4500        AND  A           ;Schluss ?0A39 C8       4510        RET  Z0A3A D7       4520        RST  10H         ;zeichenweise Ausgab0A3B 18F8     4530        JR   SDWRE3              4540 ;              4550 ;      **********************************              4560 ;0A3D 00096C0D 4570        DEFB 0,9,KLOAD,0DH  ;Kennung SD laden0A41 CDBC08   4580        CALL PICOMW      ;PIO Kommunikation0A44 3E6C     4590        LD   A,KLOAD     ;Kennung an Pico0A46 CDE308   4600        CALL WRBYTE              4610 ;0A49 CD8709   4620        CALL WRHDRX      ;Dateinamen senden              4630 ;0A4C CD0509   4640        CALL RDSYNC      ;auf Antwort warten0A4F FE55     4650        CP   55H0A51 C0       4660        RET  NZ              4670 ;0A52 CD3D09   4680        CALL RDBYTE      ;01: Text / 02:Daten0A55 FE02     4690        CP   2           ;Kennung: Data0A57 2808     4700        JR   Z,RDSD4              4710 ;      Text bis 00H0A59 CD3D09   4720 RDSD5  CALL RDBYTE0A5C A7       4730        AND  A           ;Endekennung ?0A5D C8       4740        RET  Z0A5E D7       4750        RST  10H         ;Einzelzeichen ausg.0A5F 18F8     4760        JR   RDSD5              4770 ;      Gesamtlaenge --> DE0A61 CD3D09   4780 RDSD4  CALL RDBYTE0A64 5F       4790        LD   E,A0A65 CD3D09   4800        CALL RDBYTE0A68 57       4810        LD   D,A              4820 ;              4830 ;      Header lesen ARG1-30A69 0E00     4840        LD   C,0         ;CSum0A6B 0606     4850        LD   B,6         ;Anfang, Ende, Start0A6D 215B18   4860        LD   HL,ARG10A70 CD3D09   4870 RDSD1  CALL RDBYTE0A73 77       4880        LD   (HL),A0A74 23       4890        INC  HL0A75 81       4900        ADD  A,C0A76 4F       4910        LD   C,A0A77 1B       4920        DEC  DE0A78 10F6     4930        DJNZ RDSD1              4940 ;0A7A CDC509   4950        CALL PRARGS      ;ARGs anzeigen              4960 ;              4970 ;      Kennung anzeigen 6 Zeichen0A7D DF       4980        RST  18H0A7E 2049     4990        DEFM " I"0A80 3A80     5000        DEFB ": +80H0A82 0606     5010        LD   B,60A84 CD3D09   5020 RDSD2  CALL RDBYTE0A87 D7       5030        RST  10H0A88 81       5040        ADD  A,C0A89 4F       5050        LD   C,A0A8A 1B       5060        DEC  DE0A8B 10F7     5070        DJNZ RDSD2              5080 ;              5090 ;      Datentyp anzeigen0A8D DF       5100        RST  18H0A8E 2054     5110        DEFM " T"0A90 3A80     5120        DEFB ": +80H0A92 CD3D09   5130        CALL RDBYTE0A95 D7       5140        RST  10H0A96 81       5150        ADD  A,C0A97 4F       5160        LD   C,A0A98 1B       5170        DEC  DE              5180 ;              5190 ;      3x magic Byte (nicht anzeigen)0A99 0603     5200        LD   B,30A9B CD3D09   5210 RDSDB9 CALL RDBYTE0A9E 81       5220        ADD  A,C0A9F 4F       5230        LD   C,A0AA0 1B       5240        DEC  DE0AA1 10F8     5250        DJNZ RDSDB9              5260 ;              5270 ;      Dateinamen anzeigen 16Zeichen0AA3 0610     5280        LD   B,160AA5 DF       5290        RST  18H0AA6 204E     5300        DEFM " N"0AA8 3A80     5310        DEFB ": +80H0AAA CD3D09   5320 RDSDBA CALL RDBYTE0AAD D7       5330        RST  10H0AAE 81       5340        ADD  A,C0AAF 4F       5350        LD   C,A0AB0 1B       5360        DEC  DE0AB1 10F7     5370        DJNZ RDSDBA              5380 ;0AB3 CD3D09   5390        CALL RDBYTE      ;Pruefsumme0AB6 B9       5400        CP   C0AB7 C2B709   5410        JP   NZ,ECSUM0ABA CDC90A   5420        CALL LDDATA      ;gesamt Daten lesen0ABD C0       5430        RET  NZ          ;CSUM-Error0ABE 2A5F18   5440        LD   HL,(ARG3)   ;Start-Adr -> ARG10AC1 225B18   5450        LD   (ARG1),HL0AC4 DF       5460        RST  18H0AC5 4F4B     5470        DEFM "OK"0AC7 8D       5480        DEFB 8DH0AC8 C9       5490        RET              5500 ;              5510 ;      Daten lesen0AC9 2A5B18   5520 LDDATA LD   HL,(ARG1)   ;StartAddr0ACC 0E00     5530 RDSDB1 LD   C,0         ;Blockpruefsumme0ACE 0600     5540        LD   B,00AD0 7A       5550        LD   A,D0AD1 A7       5560        AND  A           ;D=0 ?0AD2 2001     5570        JR   NZ,RDSDB20AD4 43       5580        LD   B,E         ;Block < 256 Bytes0AD5 CD3D09   5590 RDSDB2 CALL RDBYTE0AD8 77       5600        LD   (HL),A0AD9 81       5610        ADD  A,C0ADA 4F       5620        LD   C,A         ;CSum0ADB 23       5630        INC  HL          ;naechstes Ziel0ADC 1B       5640        DEC  DE          ;verbl. Laenge0ADD 10F6     5650        DJNZ RDSDB20ADF CD3D09   5660        CALL RDBYTE      ;Sollpruefsumme0AE2 B9       5670        CP   C0AE3 C2B709   5680        JP   NZ,ECSUM              5690 ;      Endepruefung0AE6 7A       5700        LD   A,D0AE7 B3       5710        OR   E0AE8 20E2     5720        JR   NZ,RDSDB1   ;naechster Block0AEA C9       5730        RET              5740 ;              5750 ; ******************************              5760 ; Zeit Ein-/Ausgabe0AEB 0009740D 5770        DEFB 0,9,KTIME,0DH0AEF CDBC08   5780        CALL PICOMW0AF2 3E74     5790        LD   A,KTIME     ;Kennung an Pico0AF4 CDE308   5800 ZCOM   CALL WRBYTE0AF7 CD8709   5810        CALL WRHDRX0AFA CD0509   5820        CALL RDSYNC0AFD FE55     5830        CP   55H0AFF C0       5840        RET  NZ0B00 CD3D09   5850        CALL RDBYTE      ;Antworttyp0B03 FE01     5860        CP   1           ;nur Text erwartet0B05 C0       5870        RET  NZ0B06 C3590A   5880        JP   RDSD5       ;lesen bis 0x00              5890 ;              5900 ; ******************************              5910 ; Directory setzen / listen0B09 0009640D 5920        DEFB 0,9,KDIR,0DH0B0D CDBC08   5930        CALL PICOMW0B10 3E64     5940        LD   A,KDIR0B12 18E0     5950        JR   ZCOM              5960 ; Directory errstellen0B14 00096D0D 5970        DEFB 0,9,KMDIR,0DH0B18 CDBC08   5980        CALL PICOMW0B1B 3E6D     5990        LD   A,KMDIR0B1D 18D5     6000        JR   ZCOM              6010 ;              6020 ; ******************************              6030 ; Monitorfarben setzen "c 0:7"0B1F 0009630D 6040        DEFB 0,9,KCOLOR,0DH0B23 CDBC08   6050        CALL PICOMW0B26 3E63     6060        LD   A,KCOLOR0B28 18CA     6070        JR   ZCOM              6080 ;              6090 ; ******************************              6100 ; Hilfetext Ur-AC1 anzeigen0B2A 0009480D 6110        DEFB 0,9,KHELP,0DH0B2E CDBC08   6120        CALL PICOMW0B31 3E48     6130        LD   A,KHELP0B33 18BF     6140        JR   ZCOM              6150 ;              6160 ; ******************************              6170 ; Hilfetext Monitorerweiterung anzeigen0B35 0009680D 6180        DEFB 0,9,KHELPX,0DH0B39 CDBC08   6190        CALL PICOMW0B3C 3E68     6200        LD   A,KHELPX0B3E 18B4     6210        JR   ZCOM              6220 ;              6230 ; ******************************              6240 ; Zeichen im Akku in Textdatei schreiben0B40 F5       6250 PRNTXA PUSH AF0B41 3ECF     6260        LD   A,0CFH0B43 D307     6270        OUT  (PIOCB),A   ;PIO-B Bitmode0B45 3E8F     6280        LD   A,8FH0B47 D307     6290        OUT  (PIOCB),A   ;I/O ->1000 11110B49 F1       6300        POP  AF0B4A CDE308   6310        CALL WRBYTE0B4D C9       6320        RET              6330 ;              6340 ;              6350 ; Datei zum Schreiben oeffnen              6360 ; Inputdaten:              6370 ;   ARG1-3 - Anfang, Ende, Start ->Header              6380 ;   TXTBUF - Dateiname, max 16Z, Ende:' '              6390 ;   FTYPE  - Dateityp -> Header              6400 ; Ergebnisdaten:              6410 ;   ARG1: Anzahl der erwartenden Bytes              6420 ;   keine externe Aenderung zulaessig0B4E F5       6430 FOPENW PUSH AF0B4F E5       6440        PUSH HL0B50 D5       6450        PUSH DE0B51 C5       6460        PUSH BC0B52 CDBC08   6470        CALL PICOMW      ;Init ZCOM Write0B55 3EF7     6480        LD   A,KFOPNW    ;Kennung an picoIO0B57 CDE308   6490        CALL WRBYTE              6500 ;      Argumente senden0B5A 0606     6510        LD   B,60B5C 0E00     6520        LD   C,00B5E 215B18   6530        LD   HL,ARG10B61 7E       6540 FOPNW1 LD   A,(HL)0B62 CDE308   6550        CALL WRBYTE0B65 81       6560        ADD  A,C0B66 4F       6570        LD   C,A         ;CSum0B67 23       6580        INC  HL0B68 10F7     6590        DJNZ FOPNW1              6600 ;              6610 ;      Dateityp senden, 1Byte0B6A 218818   6620        LD   HL,FTYPE0B6D 7E       6630        LD   A,(HL)0B6E CDE308   6640        CALL WRBYTE0B71 81       6650        ADD  A,C0B72 4F       6660        LD   C,A              6670 ;              6680 ;      Dateinamen senden0B73 218918   6690        LD   HL,TXTBUF0B76 0610     6700        LD   B,BUFLEN0B78 7E       6710 FOPNW2 LD   A,(HL)0B79 FE20     6720        CP   20H0B7B 2808     6730        JR   Z,FOPNW30B7D CDE308   6740        CALL WRBYTE0B80 81       6750        ADD  A,C0B81 4F       6760        LD   C,A0B82 23       6770        INC  HL0B83 10F3     6780        DJNZ FOPNW20B85 AF       6790 FOPNW3 XOR  A           ;Schlusskennung0B86 CDE308   6800        CALL WRBYTE0B89 79       6810        LD   A,C         ;CSum senden0B8A CDE308   6820        CALL WRBYTE0B8D 2A5D18   6830        LD   HL,(ARG2)0B90 ED5B5B18 6840        LD   DE,(ARG1)0B94 A7       6850        AND  A0B95 ED52     6860        SBC  HL,DE0B97 23       6870        INC  HL0B98 228218   6880        LD   (FLEN),HL   ;Datenlaenge0B9B 210000   6890        LD   HL,00B9E 228418   6900        LD   (FPOS),HL   ;Byte-Counter0BA1 229918   6910        LD   (FCSUM),HL   ;Block-CSum (LB)0BA4 C1       6920        POP  BC0BA5 D1       6930        POP  DE0BA6 E1       6940        POP  HL0BA7 F1       6950        POP  AF0BA8 C9       6960        RET              6970 ;              6980 ;              6990 ; Schreiben eines Zeichens in A -> ext.Datei              7000 ; ---------------------------------------0BA9 E5       7010 FCHRW  PUSH HL0BAA D5       7020        PUSH DE0BAB C5       7030        PUSH BC0BAC CDE308   7040        CALL WRBYTE      ;A --> ZCOM0BAF 2A8218   7050        LD   HL,(FLEN)   ;Laenge gesamt0BB2 ED5B8418 7060        LD   DE,(FPOS)   ;Laenge bisher0BB6 ED4B9918 7070        LD   BC,(FCSUM)  ;C - CSum0BBA 81       7080        ADD  A,C0BBB 4F       7090        LD   C,A0BBC 13       7100        INC  DE          ;Byte-Counter + 10BBD ED538418 7110        LD   (FPOS),DE0BC1 7B       7120        LD   A,E         ;Blockende (mod 256)0BC2 B7       7130        OR   A0BC3 2004     7140        JR   NZ,FCHRW10BC5 79       7150        LD   A,C0BC6 CDE308   7160        CALL WRBYTE      ;Block-CSum0BC9 ED52     7170 FCHRW1 SBC  HL,DE0BCB 201A     7180        JR   NZ,FCHRW3              7190 ;      Datenende ist erreicht0BCD 79       7200        LD   A,C0BCE CDE308   7210        CALL WRBYTE      ;CSum letzter Block              7220 ;0BD1 CD0509   7230        CALL RDSYNC      ;warten auf Antwort0BD4 FE55     7240        CP   CSYNC0BD6 200A     7250        JR   NZ,FCHRW2   ;Timeout - A=FFh0BD8 CD3D09   7260        CALL RDBYTE      ;Antworttyp 3 (fix)0BDB CD3D09   7270        CALL RDBYTE      ;Gesamt-CSum 00h=Ok0BDE 6F       7280        LD   L,A0BDF CD3D09   7290        CALL RDBYTE      ;Fehlercode SD 00=Ok0BE2 67       7300 FCHRW2 LD   H,A0BE3 228018   7310        LD   (FRESCO),HL0BE6 AF       7320        XOR  A           ;Z=0 -> Ende0BE7 ED439918 7330 FCHRW3 LD   (FCSUM),BC0BEB C1       7340        POP  BC0BEC D1       7350        POP  DE0BED E1       7360        POP  HL0BEE C9       7370        RET              7380 ;              7390 ;Schreiben eines Speicherblocks ab (ARG1)              7400 ;Datenlaenge  in FOPENW festgelegt0BEF E5       7410 FBLKW  PUSH HL0BF0 2A5B18   7420        LD   HL,(ARG1)0BF3 7E       7430 FBLKW1 LD   A,(HL)0BF4 23       7440        INC  HL0BF5 CDA90B   7450        CALL FCHRW0BF8 20F9     7460        JR   NZ,FBLKW10BFA CD5C08   7470        CALL FGETRE      ;Zy = 1 ==> Ok0BFD E1       7480        POP  HL0BFE C9       7490        RET              7500 ;              7510 ; ***********************              7520 ; Datei ext. Lesen oeffen0BFF F5       7530 FOPENR PUSH AF0C00 E5       7540        PUSH HL0C01 C5       7550        PUSH BC0C02 CDBC08   7560        CALL PICOMW      ;Init ZCOM0C05 3EF2     7570        LD   A,KFOPNR    ;Kennung0C07 CDE308   7580        CALL WRBYTE0C0A 0E00     7590        LD   C,0         ;CSum              7600 ;      Dateinamen senden0C0C 218918   7610        LD   HL,TXTBUF0C0F 0610     7620        LD   B,BUFLEN    ;max Laenge0C11 7E       7630 FOPNR1 LD   A,(HL)0C12 FE20     7640        CP   20H         ;Ende ?0C14 2808     7650        JR   Z,FOPNR20C16 CDE308   7660        CALL WRBYTE0C19 81       7670        ADD  A,C0C1A 4F       7680        LD   C,A0C1B 23       7690        INC  HL0C1C 10F3     7700        DJNZ FOPNR10C1E AF       7710 FOPNR2 XOR  A           ;Endekennung0C1F CDE308   7720        CALL WRBYTE0C22 79       7730        LD   A,C         ;CSum Name0C23 CDE308   7740        CALL WRBYTE0C26 CD2D0C   7750        CALL FOPNRX      ;Antwort pIO0C29 C1       7760        POP  BC0C2A E1       7770        POP  HL0C2B F1       7780        POP  AF0C2C C9       7790        RET  ;ErgCode in FRESCO              7800 ;              7810 ;auf Antwort pIO warten0C2D CD0509   7820 FOPNRX CALL RDSYNC0C30 FE55     7830        CP   CSYNC       ;A=55h0C32 21FE00   7840        LD   HL,00FEH    ;Fehlercode Timeout0C35 206C     7850        JR   NZ,FOPNR7   ;A=0FFh              7860 ;0C37 CD3D09   7870        CALL RDBYTE      ;Antworttyp 2/30C3A FE02     7880        CP   2           ;Daten folgen0C3C 280A     7890        JR   Z,FOPNR3              7900 ;              7910 ;      Fehlercode empfangen 2Bytes0C3E CD3D09   7920        CALL RDBYTE0C41 6F       7930        LD   L,A0C42 CD3D09   7940        CALL RDBYTE0C45 67       7950        LD   H,A0C46 185B     7960        JR   FOPNR7              7970 ;              7980 ;      Datenlaenge, 2Bytes - ohne CSum0C48 CD3D09   7990 FOPNR3 CALL RDBYTE0C4B 6F       8000        LD   L,A0C4C CD3D09   8010        CALL RDBYTE0C4F 67       8020        LD   H,A0C50 A7       8030        AND  A0C51 012000   8040        LD   BC,32       ;diff Header0C54 ED42     8050        SBC  HL,BC0C56 228218   8060        LD   (FLEN),HL              8070 ;              8080 ;      Header laden0C59 0E00     8090        LD   C,0         ;CSum fortl.0C5B 0606     8100        LD   B,6         ;ARG1..30C5D 215B18   8110        LD   HL,ARG10C60 CD3D09   8120 FOPNR4 CALL RDBYTE0C63 77       8130        LD   (HL),A0C64 81       8140        ADD  A,C0C65 4F       8150        LD   C,A0C66 23       8160        INC  HL0C67 10F7     8170        DJNZ FOPNR4              8180 ;      Dummydaten - freies Textfeld 6Bytes0C69 0606     8190        LD   B,60C6B CD3D09   8200 FOPNR8 CALL RDBYTE0C6E 81       8210        ADD  A,C0C6F 4F       8220        LD   C,A0C70 10F9     8230        DJNZ FOPNR8              8240 ;              8250 ;      Datei-Typ0C72 CD3D09   8260        CALL RDBYTE0C75 328818   8270        LD   (FTYPE),A0C78 81       8280        ADD  A,C0C79 4F       8290        LD   C,A              8300 ;              8310 ;      3x magic Bytes0C7A 0603     8320        LD   B,30C7C CD3D09   8330 FOPNR9 CALL RDBYTE0C7F 81       8340        ADD  A,C0C80 4F       8350        LD   C,A0C81 10F9     8360        DJNZ FOPNR9              8370 ;              8380 ;      Infotext / Dateiname0C83 CD4308   8390        CALL CLRBUF0C86 0610     8400        LD   B,BUFLEN0C88 218918   8410        LD   HL,TXTBUF0C8B CD3D09   8420 FOPNR5 CALL RDBYTE0C8E A7       8430        AND  A           ;Textende?0C8F 2806     8440        JR   Z,FOPNR60C91 77       8450        LD   (HL),A0C92 81       8460        ADD  A,C0C93 4F       8470        LD   C,A0C94 23       8480        INC  HL0C95 10F4     8490        DJNZ FOPNR50C97 210000   8500 FOPNR6 LD   HL,00C9A CD3D09   8510        CALL RDBYTE      ;CSum0C9D B9       8520        CP   C0C9E 2803     8530        JR   Z,FOPNR70CA0 21FF00   8540        LD   HL,00FFH    ;Fehlercode CSum Hdr0CA3 228018   8550 FOPNR7 LD   (FRESCO),HL0CA6 210000   8560        LD   HL,00CA9 228418   8570        LD   (FPOS),HL   ;akt.Byteposition0CAC 229918   8580        LD   (FCSUM),HL  ;Startwert CSum0CAF C9       8590        RET              8600 ;              8610 ; naechstes Byte von der ZCOM holen0CB0 E5       8620 FCHRR  PUSH HL0CB1 D5       8630        PUSH DE0CB2 C5       8640        PUSH BC0CB3 2A8218   8650        LD   HL,(FLEN)0CB6 ED5B8418 8660        LD   DE,(FPOS)0CBA ED4B9918 8670        LD   BC,(FCSUM)0CBE CD3D09   8680        CALL RDBYTE      ;Datenbyte lesen0CC1 47       8690        LD   B,A         ;Byte zwischensp.0CC2 81       8700        ADD  A,C         ;CSum0CC3 4F       8710        LD   C,A0CC4 13       8720        INC  DE          ;naechste Pos0CC5 ED538418 8730        LD   (FPOS),DE0CC9 A7       8740        AND  A0CCA ED52     8750        SBC  HL,DE       ;Dateiende ?0CCC F5       8760        PUSH AF0CCD 2804     8770        JR   Z,FCHRR10CCF 7B       8780        LD   A,E         ;Blockende ?0CD0 B7       8790        OR   A0CD1 200D     8800        JR   NZ,FCHRR20CD3 CD3D09   8810 FCHRR1 CALL RDBYTE      ;CSum lesen0CD6 B9       8820        CP   C0CD7 0E00     8830        LD   C,0         ;CSum ruecksetzen0CD9 2805     8840        JR   Z,FCHRR20CDB 218018   8850        LD   HL,FRESCO   ;Fehlerbit setzen0CDE CBFE     8860        SET  7,(HL)0CE0 ED439918 8870 FCHRR2 LD   (FCSUM),BC0CE4 F1       8880        POP  AF          ;Z-Flag zurueckholen0CE5 78       8890        LD   A,B         ;gelesenes Byte0CE6 C1       8900        POP  BC0CE7 D1       8910        POP  DE0CE8 E1       8920        POP  HL0CE9 C9       8930        RET              8940 ;              8950 ; Lesen einer Datei in RAM ab (ARG1)0CEA E5       8960 FBLKR  PUSH HL0CEB 2A5B18   8970        LD   HL,(ARG1)0CEE CDB00C   8980 FBLKR1 CALL FCHRR0CF1 77       8990        LD   (HL),A0CF2 23       9000        INC  HL0CF3 20F9     9010        JR   NZ,FBLKR10CF5 CD5C08   9020        CALL FGETRE      ;Zy = 1 ==> Ok0CF8 E1       9030        POP  HL0CF9 C9       9040        RET              9050 ;              9060 ;              9070 ; **********************************              9080 ; ext Kommandos in RAM laden              9090 ;0CFA CDBC08   9100 LEXCMD CALL PICOMW0CFD 3EEB     9110        LD   A,KEXCMD    ;Kennung senden0CFF CDE308   9120        CALL WRBYTE0D02 3A8818   9130        LD   A,(FTYPE)   ;Kommando senden0D05 CDE308   9140        CALL WRBYTE0D08 CD2D0C   9150        CALL FOPNRX      ;Antw.pIO, header0D0B CD5C08   9160        CALL FGETRE      ;Fehlerpruefung0D0E C0       9170        RET  NZ              9180 ;0D0F 2A5B18   9190        LD   HL,(ARG1)   ;AAdr aus Header0D12 CDB00C   9200 LEXCM1 CALL FCHRR       ;Datenbytes abholen0D15 77       9210        LD   (HL),A0D16 23       9220        INC  HL0D17 20F9     9230        JR   NZ,LEXCM10D19 C9       9240        RET              9250 ;              9260 ; ext Einzelkommandos              9270 ;              9280 ;      Minibasic0D1A 00095A0D 9290        DEFB 0,9,"Z,0DH0D1E 3E5A     9300        LD   A,"Z        ;Kennung MiBasic0D20 328818   9310        LD   (FTYPE),A0D23 CDFA0C   9320        CALL LEXCMD      ;Binary laden0D26 CD5C08   9330        CALL FGETRE      ;Fehlerpruefung0D29 C0       9340        RET  NZ0D2A 2A5F18   9350        LD   HL,(ARG3)   ;Programm starten0D2D E9       9360        JP   (HL)              9370 ;          ***** 0000 Errors *****