 AC1 U880 Assembler - Source Listing               0010 ; Sprungvetteiler Ur-AC192E4 07EB     0020 MS30   EQU  07EBH92E4 07EE     0030 OUTHEX EQU  07EEH92E4 07F1     0040 OUTHL  EQU  07F1H92E4 07F4     0050 INLINE EQU  07F4H92E4 07F7     0060 INHEX  EQU  07F7H92E4 07FA     0070 TASTTE EQU  07FAH92E4 07FD     0080 GETCO1 EQU  07FDH              0090 ;              0100 ; Systemzellen Ur-AC192E4 181A     0110 SOIL   EQU  181AH92E4 185B     0120 ARG1   EQU  185BH92E4 185D     0130 ARG2   EQU  185DH92E4 185F     0140 ARG3   EQU  185FH              0150 ;1880          0160        ORG  1880H1880 0001     0170 FTYPE  DEFS 11881 0100     0180 RESCOD DEFW 1     ;Fehlercoe ext. Save/Load1883 0010     0190 BUFLEN EQU  16    ;max Textpuffer1883 0010     0200 TXTBUF DEFS BUFLEN              0210 ;              0220 ;1893 0004     0230 PIODA  EQU  41893 0005     0240 PIODB  EQU  51893 0006     0250 PIOCA  EQU  61893 0007     0260 PIOCB  EQU  7              0270 ;1893 0005     0280 CLK    EQU  5     ;Taktletung PIOB-Bit --> P1893 0004     0290 DATA   EQU  4     ;bidrektional Daten-Ltg              0300 ;              0310 ;      Kennbuchstaben Monitorerweiterung1893 0073     0320 KSAVE  EQU  "s1893 006C     0330 KLOAD  EQU  "l1893 0074     0340 KTIME  EQU  "t1893 0064     0350 KDIR   EQU  "d1893 006D     0360 KMDIR  EQU  "m1893 0063     0370 KCOLOR EQU  "c1893 0048     0380 KHELP  EQU  "H1893 0068     0390 KHELPX EQU  "h1893 0070     0400 KPRNTX EQU  "p1893 00F7     0410 KFOPNW EQU  "w+80H1893 00F2     0420 KFOPNR EQU  "r+80H              0430 ;1893 0055     0440 CSYNC  EQU  55H         ;ZCOM Synczeichen              0450 ; -----------------------------------------              0460 ;0800          0470        ORG  0800H0800 0010     0480        DEFS 16          ;Reserv.MON11-Anp.              0490 ;              0500 ; Sprungverteiler Monitorerweiterung -------0810 C33108   0510        JP   CLRBUF ;Namebuffer loeschen0813 C34308   0520        JP   GETTXT ;Eingabetext -> Namebuff.0816 C3210B   0530        JP   PRNTXA ;A -> Druckdatei0819 C37D08   0540        JP   CRC16  ;CRC-Summe Speichebereich081C C32F0B   0550        JP   FOPENW ;ext. Datei open write081F C38A0B   0560        JP   FCHRW  ;Byte in ext.Datei schr.0822 C3D00B   0570        JP   FOPENR ;ext.Datei open read0825 C3D10B   0580        JP   FCHRR  ;Byte aus ext.Datei lesen              0590 ;              0600 ;0828 20       0610        DEFB 20H         ;DummyString0829 2A20     0620 DEFSTR DEFM "* "082B 76332E31 0630 AC1ID  DEFM "v3.1_1"    ;6Z f. Dateiheader     5F31              0640 ; ------------------------------------------              0650 ;      System-Text-Puffer loeschen (Spaces)0831 F5       0660 CLRBUF PUSH AF0832 C5       0670        PUSH BC0833 D5       0680        PUSH DE0834 0610     0690        LD   B,BUFLEN0836 3E20     0700        LD   A,20H0838 118318   0710        LD   DE,TXTBUF083B 12       0720 CLRBU1 LD   (DE),A083C 13       0730        INC  DE083D 10FC     0740        DJNZ CLRBU1083F D1       0750        POP  DE0840 C1       0760        POP  BC0841 F1       0770        POP  AF0842 C9       0780        RET              0790 ;              0800 ; Text aus Bildzeile in Systempuffer kopiere              0810 ; In: HL=1.Bildposition oder (SOIL)              0820 ; Out: StrLen --> HL              0830 ;              0840 ;      Suche hinter Kennbuchstaben0843 2A1A18   0850 GETTXT LD   HL,(SOIL)0846 2B       0860        DEC  HL              0870 ;      Suche ab HL - revese0847 F5       0880 GETTX0 PUSH AF0848 D5       0890        PUSH DE0849 C5       0900        PUSH BC084A CD3108   0910        CALL CLRBUF              0920 ;              0930 ;      Doppelp. auf 1.Position ueberspringen084D 7E       0940        LD   A,(HL)084E FE3A     0950        CP   ":0850 2001     0960        JR   NZ,GETTX20852 2B       0970        DEC  HL              0980 ;      max. 10 Leerz. vor Text0853 060A     0990 GETTX2 LD   B,100855 7E       1000 GETTX3 LD   A,(HL)0856 FE20     1010        CP   20H0858 C26308   1020        JP   NZ,GETTX4085B 2B       1030        DEC  HL085C 10F7     1040        DJNZ GETTX3085E 210000   1050        LD   HL,00861 1816     1060        JR   GETTXX      ;kein Text gefunden              1070 ;              1080 ; String bis zum naechsten Leez. kopieren0863 118318   1090 GETTX4 LD   DE,TXTBUF0866 0610     1100        LD   B,BUFLEN0868 7E       1110 GETTX5 LD   A,(HL)0869 FE20     1120        CP   20H         ;StringEnde?086B 2805     1130        JR   Z,GETTX6086D 12       1140        LD   (DE),A086E 2B       1150        DEC  HL086F 13       1160        INC  DE0870 10F6     1170        DJNZ GETTX50872 EB       1180 GETTX6 EX   DE,HL0873 118318   1190        LD   DE,TXTBUF0876 A7       1200        AND  A0877 ED52     1210        SBC  HL,DE       ;StrLen -> HL0879 C1       1220 GETTXX POP  BC087A D1       1230        POP  DE087B F1       1240        POP  AF087C C9       1250        RET              1260 ; ------------------------------------------              1270 ;      CRC16-CITT              1280 ;      Poly: 1021h / Seed: FFFFh              1290 ;      Input              1300 ;        IX: Data-Adress              1310 ;        DE: Data-Length              1320 ;      Output: HL              1330 ;      Modified: IX,DE,BC,AF,HL              1340 ;087D 21FFFF   1350 CRC16  LD   HL,0FFFFH0880 0E08     1360        LD   C,80882 7C       1370 CRC16A LD   A,H0883 DDAE00   1380        XOR  (IX+0)0886 67       1390        LD   H,A0887 DD23     1400        INC  IX0889 41       1410        LD   B,C088A 29       1420 CRC16B ADD  HL,HL088B 3008     1430        JR   NC,CRC16C088D 7C       1440        LD   A,H088E EE10     1450        XOR  10H0890 67       1460        LD   H,A0891 7D       1470        LD   A,L0892 EE21     1480        XOR  21H0894 6F       1490        LD   L,A0895 10F3     1500 CRC16C DJNZ CRC16B0897 1B       1510        DEC  DE0898 7A       1520        LD   A,D0899 B3       1530        OR   E089A 20E6     1540        JR   NZ,CRC16A089C C9       1550        RET              1560 ;              1570 ;              1580 ;              1590 ;      Initialisierung ZCOM              1600 ;      PIO Schreibrichtung089D F5       1610 PICOMW PUSH AF089E 3ECF     1620        LD   A,0CFH      ;PIO Mode 308A0 D307     1630        OUT  (PIOCB),A08A2 3E8F     1640        LD   A,08FH      ;10001111 Bitrichtun08A4 D307     1650        OUT  (PIOCB),A08A6 AF       1660        XOR  A08A7 D305     1670        OUT  (PIODB),A   ;Data & CLk -> 008A9 3E14     1680        LD   A,20        ;Low verlaengern08AB 3D       1690 PICOM1 DEC  A08AC 20FD     1700        JR   NZ,PICOM1              1710 ;      Masterkennung08AE 3EC3     1720        LD   A,0C3H08B0 CDC408   1730        CALL WRBYTE08B3 3E25     1740        LD   A,25H08B5 CDC408   1750        CALL WRBYTE08B8 3EA7     1760        LD   A,0A7H08BA CDC408   1770        CALL WRBYTE08BD 3E56     1780        LD   A,56H08BF CDC408   1790        CALL WRBYTE08C2 F1       1800        POP  AF08C3 C9       1810        RET              1820 ;      ---------------              1830 ;              1840 ;      Zeichen in A augeben08C4 C5       1850 WRBYTE PUSH BC08C5 F5       1860        PUSH AF08C6 0608     1870        LD   B,8          ;Bitzaehler08C8 4F       1880        LD   C,A08C9 DB05     1890        IN   A,(PIODB)08CB CBAF     1900        RES  CLK,A         ;Anfangzust. CLK08CD D305     1910        OUT  (PIODB),A              1920 ;08CF DB05     1930 WRBY1  IN   A,(PIODB)08D1 E6CF     1940        AND  0CFH        ;CLK & Daten !08D3 CB40     1950        BIT  0,B08D5 2002     1960        JR   NZ,WRBY208D7 CBEF     1970        SET  CLK,A08D9 CB29     1980 WRBY2  SRA  C           ;Datenbit -> Cy08DB 3002     1990        JR   NC,WRBY308DD CBE7     2000        SET  DATA,A08DF D305     2010 WRBY3  OUT  (PIODB),A08E1 10EC     2020        DJNZ WRBY108E3 F1       2030        POP  AF08E4 C1       2040        POP  BC08E5 C9       2050        RET              2060 ;      ----------------              2070 ;              2080 ;      PIO in Leserichtung umschalten              2090 ;      auf Synchronbyte "55H" warten08E6 C5       2100 RDSYNC PUSH BC              2110 ;      PUSH DE08E7 E5       2120        PUSH HL08E8 3ECF     2130        LD   A,0CFH      ;PIO Mode 308EA D307     2140        OUT  (PIOCB),A08EC 3E9F     2150        LD   A,9FH      ;1001 1111 Richtung08EE D307     2160        OUT  (PIOCB),A08F0 21B80B   2170        LD   HL,3000     ;max x Flanken              2180 ;      LD   DE,1        ;dec HL08F3 0E00     2190        LD   C,008F5 DB05     2200 RDSY1  IN   A,(PIODB)08F7 EE20     2210        XOR  20H          ;CLK toggeln08F9 D305     2220        OUT  (PIODB),A08FB CB39     2230        SRL  C08FD CB67     2240        BIT  DATA,A08FF 2802     2250        JR   Z,RDSY30901 CBF9     2260        SET  7,C0903 79       2270 RDSY3  LD   A,C0904 FE55     2280        CP   CSYNC0906 2813     2290        JR   Z,RDSY4              2300 ;      Takvezoegerung0908 AF       2310        XOR  A           ;Cy = 00909 3D       2320 RDSY5  DEC  A           ;Cy unveraendert090A 20FD     2330        JR   NZ,RDSY5              2340 ;      SBC  HL,DE       ;HL - 1090C 2B       2350        DEC  HL090D 7D       2360        LD   A,L090E B4       2370        OR   H           ; HL = 0 ??090F 20E4     2380        JR   NZ,RDSY10911 DF       2390        RST  18H0912 54494D45 2400        DEFM "TIMEOU"     4F550918 D4       2410        DEFB "T+80H0919 3EFF     2420        LD   A,0FFH      ;A: FFH = Fehler091B E1       2430 RDSY4  POP  HL              2440 ;      POP  DE091C C1       2450        POP  BC091D C9       2460        RET  ;A: CSYN = Ok              2470 ;      ----------------              2480 ;              2490 ;      Zeichen vom Pico lesen              2500 ;      Ergebnis in A              2510 ;      Datenbit 0 steht bereits an091E C5       2520 RDBYTE PUSH BC091F 0608     2530        LD   B,8         ;Bitzaehler0921 0E00     2540        LD   C,0         ;Ergebnis0923 DB05     2550 RDBY1  IN   A,(PIODB)0925 EE20     2560        XOR  20H          ;CLK toggeln0927 D305     2570        OUT  (PIODB),A0929 CB39     2580        SRL  C092B CB67     2590        BIT  DATA,A092D 2802     2600        JR   Z,RDBY2092F CBF9     2610        SET  7,C0931 10F0     2620 RDBY2  DJNZ RDBY10933 79       2630        LD   A,C0934 C1       2640        POP  BC0935 C9       2650        RET              2660 ;      --------------              2670 ;              2680 ;      Datei-Header an Pico senden              2690 ;      A => Dateityp - "P|D|B|F|E"              2700 ;      ARG1-3 in Systemzellen0936 F5       2710 WRHDR  PUSH AF0937 215B18   2720        LD   HL,ARG1093A 0606     2730        LD   B,6         ;6 Bytes093C 0E00     2740        LD   C,0         ;Pruefsumme093E 7E       2750 WRHDR0 LD   A,(HL)093F CDC408   2760        CALL WRBYTE0942 81       2770        ADD  A,C0943 4F       2780        LD   C,A0944 23       2790        INC  HL0945 10F7     2800        DJNZ WRHDR0              2810 ;0947 0606     2820        LD   B,6         ;Kennung 6 Zeichen0949 212B08   2830        LD   HL,AC1ID094C 7E       2840 WRHDR7 LD   A,(HL)094D CDC408   2850        CALL WRBYTE0950 23       2860        INC  HL0951 81       2870        ADD  A,C0952 4F       2880        LD   C,A0953 10F7     2890        DJNZ WRHDR7              2900 ;0955 F1       2910        POP  AF          ;Dateityp0956 CDC408   2920        CALL WRBYTE0959 81       2930        ADD  A,C095A 4F       2940        LD   C,A              2950 ;095B 0603     2960        LD   B,3          ;3x Magic Bytes095D 3ED3     2970 WRHDR8 LD   A,0D3H095F CDC408   2980        CALL WRBYTE0962 81       2990        ADD  A,C0963 4F       3000        LD   C,A0964 10F7     3010        DJNZ WRHDR80966 1807     3020        JR   WRHDR5              3030 ;              3040 ;      Einsprung "nur Zeichenkette senden"0968 0E00     3050 WRHDRX LD   C,0096A ED5B1A18 3060        LD   DE,(SOIL)096E 1B       3070        DEC  DE096F 060A     3080 WRHDR5 LD   B,10        ;max 10 Leerz. vor S0971 1A       3090 WRHDR1 LD   A,(DE)0972 FE3A     3100        CP   ":          ;Doppelpunkt uebesp.0974 2804     3110        JR   Z,WRHDR60976 FE20     3120        CP   20H         ;Beginn String suche0978 2006     3130        JR   NZ,WRHDR2097A 1B       3140 WRHDR6 DEC  DE097B 10F4     3150        DJNZ WRHDR1097D 112908   3160        LD   DE,DEFSTR   ;Default-String0980 0621     3170 WRHDR2 LD   B,33        ;16Z Name'/'16Z Info0982 1A       3180 WRHDR4 LD   A,(DE)0983 1B       3190        DEC  DE0984 FE20     3200        CP   20H         ;Ende String suchen0986 2807     3210        JR   Z,WRHDR30988 CDC408   3220        CALL WRBYTE098B 81       3230        ADD  A,C098C 4F       3240        LD   C,A098D 10F3     3250        DJNZ WRHDR4098F AF       3260 WRHDR3 XOR  A           ;Schlusskennung0990 CDC408   3270        CALL WRBYTE0993 79       3280        LD   A,C         ;Pruefsumme Header0994 CDC408   3290        CALL WRBYTE0997 C9       3300        RET              3310 ;      ---------------              3320 ;      Fehlermeldung + Abbruch0998 F5       3330 ECSUM  PUSH AF0999 DF       3340        RST  18H099A 4353554D 3350        DEFM "CSUM ERRO"     20455252     4F09A3 D2       3360        DEFB "R+80H09A4 F1       3370        POP  AF09A5 C9       3380        RET              3390 ;      ----------------              3400 ;              3410 ;      Hex-Ausgbe ARG1-309A6 E5       3420 PRARGS PUSH HL09A7 DF       3430        RST  18H09A8 2041     3440        DEFM " A"09AA 3A80     3450        DEFB ": +80H09AC 2A5B18   3460        LD   HL,(ARG1)09AF CDF107   3470        CALL OUTHL09B2 DF       3480        RST  18H09B3 2045     3490        DEFM " E"09B5 3A80     3500        DEFB ": +80H09B7 2A5D18   3510        LD   HL,(ARG2)09BA CDF107   3520        CALL OUTHL09BD DF       3530        RST  18H09BE 2053     3540        DEFM " S"09C0 3A80     3550        DEFB ": +80H09C2 2A5F18   3560        LD   HL,(ARG3)09C5 CDF107   3570        CALL OUTHL09C8 E1       3580        POP  HL09C9 C9       3590        RET              3600 ;              3610 ;      ***************************              3620 ;      Datenfile an Pico senden09CA 0009730D 3630        DEFB 0,9,KSAVE,0DH  ;Kennbuchstabe              3640 ;09CE 2A5B18   3650        LD   HL,(ARG1)   ;Ende > Anfang ?09D1 ED4B5D18 3660        LD   BC,(ARG2)09D5 A7       3670        AND  A           ;Cy = 009D6 ED42     3680        SBC  HL,BC09D8 D0       3690        RET  NC              3700 ;09D9 CD9D08   3710        CALL PICOMW      ;PIO Schreibrichtung09DC 3E73     3720        LD   A,KSAVE     ;Kommando -> Pico09DE CDC408   3730        CALL WRBYTE              3740 ;09E1 3E44     3750        LD   A,"D        ;Kennung09E3 CD3609   3760        CALL WRHDR       ;Datei-Header senden              3770 ;              3780 ;      Daten sichen09E6 ED5B5B18 3790 SVDATA LD   DE,(ARG1)   ;Anfang09EA 2A5D18   3800        LD   HL,(ARG2)   ;Ende09ED A7       3810        AND  A           ;Cy=009EE ED52     3820        SBC  HL,DE09F0 23       3830        INC  HL          ;Laenge              3840 ;      Blockanfang09F1 010000   3850 SDWR10 LD   BC,0        ;Block=256By/CSum=009F4 7C       3860        LD   A,H09F5 A7       3870        AND  A           ;H=0? ==> <256 Bytes09F6 2005     3880        JR   NZ,SDWR1209F8 7D       3890        LD   A,L         ;HL=0?09F9 A7       3900        AND  A09FA 2811     3910        JR   Z,SDWRE2    ;Ende09FC 45       3920        LD   B,L         ;Restblock09FD 1A       3930 SDWR12 LD   A,(DE)09FE CDC408   3940        CALL WRBYTE0A01 81       3950        ADD  A,C0A02 4F       3960        LD   C,A0A03 13       3970        INC  DE          ;naechste Adr0A04 2B       3980        DEC  HL          ;Restlaenge -10A05 10F6     3990        DJNZ SDWR12              4000 ;      Ausgabe Pruefsumme0A07 79       4010        LD   A,C0A08 CDC408   4020        CALL WRBYTE0A0B 18E4     4030        JR   SDWR10              4040 ;              4050 ;      warten auf Meldung vom Pico0A0D CDE608   4060 SDWRE2 CALL RDSYNC0A10 FE55     4070        CP   55H         ;Syncbyte korrekt?0A12 C0       4080        RET  NZ              4090 ;0A13 CD1E09   4100        CALL RDBYTE      ;Responsetyp 01              4110 ;0A16 CD1E09   4120 SDWRE3 CALL RDBYTE0A19 A7       4130        AND  A           ;Schluss ?0A1A C8       4140        RET  Z0A1B D7       4150        RST  10H         ;zeichenweise Ausgab0A1C 18F8     4160        JR   SDWRE3              4170 ;              4180 ;      **********************************              4190 ;0A1E 00096C0D 4200        DEFB 0,9,KLOAD,0DH  ;Kennung SD laden0A22 CD9D08   4210        CALL PICOMW      ;PIO Kommunikation0A25 3E6C     4220        LD   A,KLOAD     ;Kennung an Pico0A27 CDC408   4230        CALL WRBYTE              4240 ;0A2A CD6809   4250        CALL WRHDRX      ;Dateinamen senden              4260 ;0A2D CDE608   4270        CALL RDSYNC      ;auf Antwort warten0A30 FE55     4280        CP   55H0A32 C0       4290        RET  NZ              4300 ;0A33 CD1E09   4310        CALL RDBYTE      ;01: Text / 02:Daten0A36 FE02     4320        CP   2           ;Kennung: Data0A38 2808     4330        JR   Z,RDSD4              4340 ;      Text bis 00H0A3A CD1E09   4350 RDSD5  CALL RDBYTE0A3D A7       4360        AND  A           ;Endekennung ?0A3E C8       4370        RET  Z0A3F D7       4380        RST  10H         ;Einzelzeichen ausg.0A40 18F8     4390        JR   RDSD5              4400 ;      Gesamtlaenge --> DE0A42 CD1E09   4410 RDSD4  CALL RDBYTE0A45 5F       4420        LD   E,A0A46 CD1E09   4430        CALL RDBYTE0A49 57       4440        LD   D,A              4450 ;              4460 ;      Header lesen ARG1-30A4A 0E00     4470        LD   C,0         ;CSum0A4C 0606     4480        LD   B,6         ;Anfang, Ende, Start0A4E 215B18   4490        LD   HL,ARG10A51 CD1E09   4500 RDSD1  CALL RDBYTE0A54 77       4510        LD   (HL),A0A55 23       4520        INC  HL0A56 81       4530        ADD  A,C0A57 4F       4540        LD   C,A0A58 1B       4550        DEC  DE0A59 10F6     4560        DJNZ RDSD1              4570 ;0A5B CDA609   4580        CALL PRARGS      ;ARGs anzeigen              4590 ;              4600 ;      Kennung anzeigen 6 Zeichen0A5E DF       4610        RST  18H0A5F 2049     4620        DEFM " I"0A61 3A80     4630        DEFB ": +80H0A63 0606     4640        LD   B,60A65 CD1E09   4650 RDSD2  CALL RDBYTE0A68 D7       4660        RST  10H0A69 81       4670        ADD  A,C0A6A 4F       4680        LD   C,A0A6B 1B       4690        DEC  DE0A6C 10F7     4700        DJNZ RDSD2              4710 ;              4720 ;      Datentyp anzeigen0A6E DF       4730        RST  18H0A6F 2054     4740        DEFM " T"0A71 3A80     4750        DEFB ": +80H0A73 CD1E09   4760        CALL RDBYTE0A76 D7       4770        RST  10H0A77 81       4780        ADD  A,C0A78 4F       4790        LD   C,A0A79 1B       4800        DEC  DE              4810 ;              4820 ;      3x magic Byte (nicht anzeigen)0A7A 0603     4830        LD   B,30A7C CD1E09   4840 RDSDB9 CALL RDBYTE0A7F 81       4850        ADD  A,C0A80 4F       4860        LD   C,A0A81 1B       4870        DEC  DE0A82 10F8     4880        DJNZ RDSDB9              4890 ;              4900 ;      Dateinamen anzeigen 16Zeichen0A84 0610     4910        LD   B,160A86 DF       4920        RST  18H0A87 204E     4930        DEFM " N"0A89 3A80     4940        DEFB ": +80H0A8B CD1E09   4950 RDSDBA CALL RDBYTE0A8E D7       4960        RST  10H0A8F 81       4970        ADD  A,C0A90 4F       4980        LD   C,A0A91 1B       4990        DEC  DE0A92 10F7     5000        DJNZ RDSDBA              5010 ;0A94 CD1E09   5020        CALL RDBYTE      ;Pruefsumme0A97 B9       5030        CP   C0A98 C29809   5040        JP   NZ,ECSUM0A9B CDAA0A   5050        CALL LDDATA      ;gesamt Daten lesen0A9E C0       5060        RET  NZ          ;CSUM-Error0A9F 2A5F18   5070        LD   HL,(ARG3)   ;Start-Adr -> ARG10AA2 225B18   5080        LD   (ARG1),HL0AA5 DF       5090        RST  18H0AA6 4F4B     5100        DEFM "OK"0AA8 8D       5110        DEFB 8DH0AA9 C9       5120        RET              5130 ;              5140 ;      Daten lesen0AAA 2A5B18   5150 LDDATA LD   HL,(ARG1)   ;StartAddr0AAD 0E00     5160 RDSDB1 LD   C,0         ;Blockpruefsumme0AAF 0600     5170        LD   B,00AB1 7A       5180        LD   A,D0AB2 A7       5190        AND  A           ;D=0 ?0AB3 2001     5200        JR   NZ,RDSDB20AB5 43       5210        LD   B,E         ;Block < 256 Bytes0AB6 CD1E09   5220 RDSDB2 CALL RDBYTE0AB9 77       5230        LD   (HL),A0ABA 81       5240        ADD  A,C0ABB 4F       5250        LD   C,A         ;CSum0ABC 23       5260        INC  HL          ;naechstes Ziel0ABD 1B       5270        DEC  DE          ;verbl. Laenge0ABE 10F6     5280        DJNZ RDSDB20AC0 CD1E09   5290        CALL RDBYTE      ;Sollpruefsumme0AC3 B9       5300        CP   C0AC4 C29809   5310        JP   NZ,ECSUM              5320 ;      Endepruefung0AC7 7A       5330        LD   A,D0AC8 B3       5340        OR   E0AC9 20E2     5350        JR   NZ,RDSDB1   ;naechster Block0ACB C9       5360        RET              5370 ;              5380 ; ******************************              5390 ; Zeit Ein-/Ausgabe0ACC 0009740D 5400        DEFB 0,9,KTIME,0DH0AD0 CD9D08   5410        CALL PICOMW0AD3 3E74     5420        LD   A,KTIME     ;Kennung an Pico0AD5 CDC408   5430 ZCOM   CALL WRBYTE0AD8 CD6809   5440        CALL WRHDRX0ADB CDE608   5450        CALL RDSYNC0ADE FE55     5460        CP   55H0AE0 C0       5470        RET  NZ0AE1 CD1E09   5480        CALL RDBYTE      ;Antworttyp0AE4 FE01     5490        CP   1           ;nur Text erwartet0AE6 C0       5500        RET  NZ0AE7 C33A0A   5510        JP   RDSD5       ;lesen bis 0x00              5520 ;              5530 ; ******************************              5540 ; Directory setzen / listen0AEA 0009640D 5550        DEFB 0,9,KDIR,0DH0AEE CD9D08   5560        CALL PICOMW0AF1 3E64     5570        LD   A,KDIR0AF3 18E0     5580        JR   ZCOM              5590 ; Directory errstellen0AF5 00096D0D 5600        DEFB 0,9,KMDIR,0DH0AF9 CD9D08   5610        CALL PICOMW0AFC 3E6D     5620        LD   A,KMDIR0AFE 18D5     5630        JR   ZCOM              5640 ;              5650 ; ******************************              5660 ; Monitorfarben setzen "c 0:7"0B00 0009630D 5670        DEFB 0,9,KCOLOR,0DH0B04 CD9D08   5680        CALL PICOMW0B07 3E63     5690        LD   A,KCOLOR0B09 18CA     5700        JR   ZCOM              5710 ;              5720 ; ******************************              5730 ; Hilfetext Ur-AC1 anzeigen0B0B 0009480D 5740        DEFB 0,9,KHELP,0DH0B0F CD9D08   5750        CALL PICOMW0B12 3E48     5760        LD   A,KHELP0B14 18BF     5770        JR   ZCOM              5780 ;              5790 ; ******************************              5800 ; Hilfetext Monitorerweiterung anzeigen0B16 0009680D 5810        DEFB 0,9,KHELPX,0DH0B1A CD9D08   5820        CALL PICOMW0B1D 3E68     5830        LD   A,KHELPX0B1F 18B4     5840        JR   ZCOM              5850 ;              5860 ; ******************************              5870 ; Zeichen im Akku in Textdatei schreiben0B21 F5       5880 PRNTXA PUSH AF0B22 3ECF     5890        LD   A,0CFH0B24 D307     5900        OUT  (PIOCB),A   ;PIO-B Bitmode0B26 3E8F     5910        LD   A,8FH0B28 D307     5920        OUT  (PIOCB),A   ;I/O ->1000 11110B2A F1       5930        POP  AF0B2B CDC408   5940        CALL WRBYTE0B2E C9       5950        RET              5960 ;              5970 ;              5980 ; Datei zum Schreiben oeffnen              5990 ; Inputdaten:              6000 ;   ARG1-3 - Anfang, Ende, Start ->Header              6010 ;   TXTBUF - Dateiname, max 16Z, Ende:' '              6020 ;   FTYPE  - Dateityp -> Header              6030 ; Ergebnisdaten:              6040 ;   ARG1: Anzahl der erwartenden Bytes              6050 ;   keine externe Aenderung zulaessig0B2F F5       6060 FOPENW PUSH AF0B30 E5       6070        PUSH HL0B31 D5       6080        PUSH DE0B32 C5       6090        PUSH BC0B33 CD9D08   6100        CALL PICOMW      ;Init ZCOM Write0B36 3EF7     6110        LD   A,KFOPNW    ;Kennung an picoIO0B38 CDC408   6120        CALL WRBYTE              6130 ;      Argumente senden0B3B 0606     6140        LD   B,60B3D 0E00     6150        LD   C,00B3F 215B18   6160        LD   HL,ARG10B42 7E       6170 FOPNW1 LD   A,(HL)0B43 CDC408   6180        CALL WRBYTE0B46 81       6190        ADD  A,C0B47 4F       6200        LD   C,A         ;CSum0B48 23       6210        INC  HL0B49 10F7     6220        DJNZ FOPNW1              6230 ;              6240 ;      Dateityp senden, 1Byte0B4B 218018   6250        LD   HL,FTYPE0B4E 7E       6260        LD   A,(HL)0B4F CDC408   6270        CALL WRBYTE0B52 81       6280        ADD  A,C0B53 4F       6290        LD   C,A              6300 ;              6310 ;      Dateinamen senden0B54 218318   6320        LD   HL,TXTBUF0B57 0610     6330        LD   B,BUFLEN0B59 7E       6340 FOPNW2 LD   A,(HL)0B5A FE20     6350        CP   20H0B5C 2808     6360        JR   Z,FOPNW30B5E CDC408   6370        CALL WRBYTE0B61 81       6380        ADD  A,C0B62 4F       6390        LD   C,A0B63 23       6400        INC  HL0B64 10F3     6410        DJNZ FOPNW20B66 AF       6420 FOPNW3 XOR  A           ;Schlusskennung0B67 CDC408   6430        CALL WRBYTE0B6A 79       6440        LD   A,C         ;CSum senden0B6B CDC408   6450        CALL WRBYTE0B6E 2A5D18   6460        LD   HL,(ARG2)0B71 ED5B5B18 6470        LD   DE,(ARG1)0B75 A7       6480        AND  A0B76 ED52     6490        SBC  HL,DE0B78 23       6500        INC  HL0B79 225B18   6510        LD   (ARG1),HL   ;Datenlaenge0B7C 210000   6520        LD   HL,00B7F 225D18   6530        LD   (ARG2),HL   ;Byte-Counter0B82 225F18   6540        LD   (ARG3),HL   ;Block-CSum (C)0B85 C1       6550        POP  BC0B86 D1       6560        POP  DE0B87 E1       6570        POP  HL0B88 F1       6580        POP  AF0B89 C9       6590        RET              6600 ;              6610 ;              6620 ; Schreiben eines Zeichens in A -> ext.Datei              6630 ; ---------------------------------------0B8A E5       6640 FCHRW  PUSH HL0B8B D5       6650        PUSH DE0B8C C5       6660        PUSH BC0B8D CDC408   6670        CALL WRBYTE      ;A --> ZCOM0B90 2A5B18   6680        LD   HL,(ARG1)   ;Laenge gesamt0B93 ED5B5D18 6690        LD   DE,(ARG2)   ;Laenge bisher0B97 ED4B5F18 6700        LD   BC,(ARG3)   ;C - CSum0B9B 81       6710        ADD  A,C0B9C 4F       6720        LD   C,A0B9D 13       6730        INC  DE          ;Byte-Counter + 10B9E ED535D18 6740        LD   (ARG2),DE0BA2 7B       6750        LD   A,E         ;Blockende (mod 256)0BA3 B7       6760        OR   A0BA4 2004     6770        JR   NZ,FCHRW10BA6 79       6780        LD   A,C0BA7 CDC408   6790        CALL WRBYTE      ;Block-CSum0BAA ED52     6800 FCHRW1 SBC  HL,DE0BAC 201A     6810        JR   NZ,FCHRW3              6820 ;      Datenende ist erreicht0BAE 79       6830        LD   A,C0BAF CDC408   6840        CALL WRBYTE      ;CSum letzter Block              6850 ;0BB2 CDE608   6860        CALL RDSYNC      ;warten auf Antwort0BB5 FE55     6870        CP   CSYNC0BB7 200A     6880        JR   NZ,FCHRW2   ;Timeout - A=FFh0BB9 CD1E09   6890        CALL RDBYTE      ;Antworttyp 3 (fix)0BBC CD1E09   6900        CALL RDBYTE      ;Gesamt-CSum 00h=Ok0BBF 6F       6910        LD   L,A0BC0 CD1E09   6920        CALL RDBYTE      ;Fehlercode SD 00=Ok0BC3 67       6930 FCHRW2 LD   H,A0BC4 228118   6940        LD   (RESCOD),HL0BC7 AF       6950        XOR  A           ;Z=0 -> Ende0BC8 ED435F18 6960 FCHRW3 LD   (ARG3),BC0BCC C1       6970        POP  BC0BCD D1       6980        POP  DE0BCE E1       6990        POP  HL0BCF C9       7000        RET              7010 ;              7020 ; Datei ext. Lesen oeffen0BD0 C9       7030 FOPENR RET              7040 ;              7050 ; naechstes Byte aus Datei lesen0BD1 AF       7060 FCHRR  XOR  A0BD2 C9       7070        RET          ***** 0000 Errors *****